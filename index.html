<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor CNIS para Excel</title>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }
        h1 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        p {
            font-size: 1rem;
            color: #666;
            margin-bottom: 2rem;
        }
        .input-group {
            margin-bottom: 1.5rem;
        }
        input[type="file"] {
            border: 2px dashed #bdc3c7;
            padding: 1.5rem;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }
        input[type="file"]:hover {
            border-color: #3498db;
        }
        .btn {
            display: inline-block;
            background-color: #3499db;
            color: #fff;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #2ecc71;
            margin-top: 1rem;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        #status-message {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #e74c3c;
            min-height: 20px;
        }
        #download-link {
            display: none;
        }
        #extraction-options {
            display: none;
            margin-top: 2rem;
        }
        #pdf-text-container {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: scroll;
        }
        .highlighted-text {
            background-color: #e7f3ff;
            font-weight: bold;
        }
        .column-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1.5rem;
        }
        .column-selector button {
            background-color: #f0f2f5;
            color: #333;
            border: 1px solid #ccc;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
        }
        .column-selector button.selected {
            background-color: #3498db;
            color: #fff;
            border-color: #3498db;
        }
        #preview-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Conversor de Extrato CNIS</h1>
        <p>Importe seu arquivo PDF do CNIS para convertê-lo em uma planilha Excel.</p>
        <div class="input-group">
            <input type="file" id="pdfFile" accept=".pdf">
        </div>
        <button id="convertBtn" class="btn">Processar PDF</button>
        <div id="status-message"></div>

        <div id="extraction-options">
            <h2>Pré-visualização do texto e seleção de colunas</h2>
            <p>Clique nas colunas que deseja extrair:</p>
            <div class="column-selector" id="column-selector">
                <button data-column="Seq.">Seq.</button>
                <button data-column="NIT">NIT</button>
                <button data-column="Código Emp./NB">Código Emp./NB</button>
                <button data-column="Origem do Vínculo">Origem do Vínculo</button>
                <button data-column="Tipo Filiado no Vínculo">Tipo Filiado no Vínculo</button>
                <button data-column="Matrícula do Trabalhador">Matrícula do Trabalhador</button>
                <button data-column="Data Início">Data Início</button>
                <button data-column="Data Fim">Data Fim</button>
                <button data-column="Últ. Remun.">Últ. Remun.</button>
                <button data-column="Indicadores">Indicadores</button>
                <button id="selectAllBtn" class="btn">Adicionar toda a tabela</button>
                <button id="removeAllBtn" class="btn">Remover todas</button>
            </div>
            <div id="preview-container">
                <h3>Prévia da Tabela:</h3>
                <table id="preview-table">
                    <thead>
                        <tr></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="pdf-text-container"></div>
            <button id="extractDataBtn" class="btn btn-success">Gerar Planilha</button>
        </div>

        <div id="download-link">
            <a href="#" id="downloadBtn" class="btn btn-success" download="extrato_cnis.xlsx">Baixar Planilha</a>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.14.305/build/pdf.worker.min.js';
        let pdfTextContent = '';

        document.getElementById('convertBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('pdfFile');
            const statusMessage = document.getElementById('status-message');
            const downloadLink = document.getElementById('download-link');
            const extractionOptions = document.getElementById('extraction-options');
            
            statusMessage.textContent = '';
            downloadLink.style.display = 'none';
            extractionOptions.style.display = 'none';
            console.log('Botão de conversão clicado.');

            if (fileInput.files.length === 0) {
                statusMessage.textContent = 'Por favor, selecione um arquivo PDF.';
                console.log('Nenhum arquivo selecionado.');
                return;
            }

            const file = fileInput.files[0];
            statusMessage.textContent = 'Processando... por favor, aguarde.';
            console.log(`Arquivo selecionado: ${file.name}`);

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    console.log('Lendo o arquivo PDF...');
                    const arrayBuffer = e.target.result;
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;
                    let fullText = '';
                    console.log(`PDF carregado com ${totalPages} páginas.`);

                    for (let i = 1; i <= totalPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += ' ' + textContent.items.map(item => item.str).join(' ');
                    }

                    pdfTextContent = fullText;
                    statusMessage.textContent = 'PDF processado. Agora, selecione as colunas para extração.';
                    document.getElementById('pdf-text-container').textContent = pdfTextContent;
                    extractionOptions.style.display = 'block';

                } catch (error) {
                    statusMessage.textContent = `Erro na conversão: ${error.message}`;
                    console.error('Erro de parsing ou processamento:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('extractDataBtn').addEventListener('click', () => {
            const statusMessage = document.getElementById('status-message');
            const selectedColumns = Array.from(document.querySelectorAll('.column-selector button.selected'))
                                         .map(btn => btn.dataset.column);
            
            if (selectedColumns.length === 0) {
                statusMessage.textContent = 'Por favor, selecione pelo menos uma coluna.';
                return;
            }

            try {
                const data = parseCNIS(pdfTextContent, selectedColumns);
                
                if (data.length === 0) {
                    const errorMsg = 'Nenhum dado de vínculo foi encontrado no PDF. Verifique se o layout do arquivo é compatível.';
                    statusMessage.textContent = errorMsg;
                    console.log(errorMsg);
                    return;
                }

                console.log('Dados de vínculo extraídos com sucesso:', data);

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Vínculos");

                XLSX.writeFile(workbook, "extrato_cnis.xlsx");

                statusMessage.textContent = 'Conversão concluída! Clique no botão para baixar.';
                document.getElementById('downloadBtn').textContent = 'Baixar extrato_cnis.xlsx';
                document.getElementById('download-link').style.display = 'block';
                console.log('Planilha gerada e link de download exibido.');

            } catch (error) {
                statusMessage.textContent = `Erro na extração: ${error.message}`;
                console.error('Erro de extração:', error);
            }
        });

        document.querySelectorAll('.column-selector button[data-column]').forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('selected');
                const selectedColumns = Array.from(document.querySelectorAll('.column-selector button.selected'))
                                             .map(btn => btn.dataset.column);
                renderTablePreview(parseCNIS(pdfTextContent, selectedColumns), selectedColumns);
            });
        });

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            const allButtons = document.querySelectorAll('.column-selector button[data-column]');
            allButtons.forEach(btn => btn.classList.add('selected'));
            const selectedColumns = Array.from(allButtons).map(btn => btn.dataset.column);
            renderTablePreview(parseCNIS(pdfTextContent, selectedColumns), selectedColumns);
        });

        document.getElementById('removeAllBtn').addEventListener('click', () => {
            const allButtons = document.querySelectorAll('.column-selector button[data-column]');
            allButtons.forEach(btn => btn.classList.remove('selected'));
            renderTablePreview([], []);
        });

        function parseCNIS(text, columns) {
            console.log('Iniciando a análise do texto para encontrar a tabela CNIS...');
            const tableData = [];
            
            // Define os marcadores de início e fim da tabela
            const startMarker = 'Relações Previdenciárias';
            const endMarker = 'O INSS poderá rever a qualquer tempo as';
            
            // Encontra o texto entre os marcadores
            let startIndex = text.indexOf(startMarker);
            let endIndex = text.indexOf(endMarker);

            if (startIndex === -1) {
                console.log('Marcador de início não encontrado.');
                return [];
            }
            if (endIndex === -1) {
                console.log('Marcador de fim não encontrado. Usando todo o texto a partir do início.');
                endIndex = text.length;
            } else if (endIndex <= startIndex) {
                console.log('Marcadores em ordem incorreta. Analisando todo o texto após o marcador de início.');
                endIndex = text.length;
            }
            
            const relevantText = text.substring(startIndex + startMarker.length, endIndex);
            console.log('Texto relevante extraído para processamento:', relevantText);

            // Adicionei logs para ajudar na depuração
            const cleanText = relevantText.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ');
            console.log('Texto processado para busca de padrões:', cleanText);
            
            // Regex para separar os blocos de dados de vínculos
            const blocks = cleanText.match(/(\d+\s+145\.[\d.-]+\s+.*?)(?=\s+\d+\s+145\.[\d.-]+|$)/g);
            
            if (!blocks) {
                console.log('Nenhum bloco de dados de vínculo encontrado. Retornando array vazio.');
                return [];
            }
            console.log('Blocos de dados de vínculo encontrados:', blocks);

            blocks.forEach(block => {
                const rowData = {};
                
                // Extração baseada nas colunas selecionadas
                if (columns.includes('Seq.')) {
                    rowData["Seq."] = (block.match(/^(\d+)/) || [])[1] || '';
                }
                if (columns.includes('NIT')) {
                    rowData["NIT"] = (block.match(/145\.[\d.-]+/) || [])[0] || '';
                }
                if (columns.includes('Código Emp./NB')) {
                    rowData["Código Emp./NB"] = (block.match(/([\d.-]+\/[\d.-]+)/) || [])[0] || '';
                }
                if (columns.includes('Origem do Vínculo')) {
                    const origemMatch = block.match(/([\d.-]+\/[\d.-]+)?\s*([A-Z\s.,&]+?)\s+(Empregado ou Agente Público|Contribuinte Individual)/);
                    if (origemMatch) {
                        const codigo = origemMatch[1] ? origemMatch[1] + ' ' : '';
                        rowData["Origem do Vínculo"] = codigo + origemMatch[2].trim();
                    } else {
                        rowData["Origem do Vínculo"] = '';
                    }
                }
                if (columns.includes('Tipo Filiado')) {
                    rowData["Tipo Filiado"] = (block.match(/(Empregado ou Agente Público|Contribuinte Individual|Outro tipo de filiado)/) || [])[1] || '';
                }
                if (columns.includes('Data Início')) {
                    rowData["Data Início"] = (block.match(/(\d{2}\/\d{2}\/\d{4})/g) || [])[0] || '';
                }
                if (columns.includes('Data Fim')) {
                    rowData["Data Fim"] = (block.match(/(\d{2}\/\d{2}\/\d{4})/g) || [])[1] || '';
                }
                if (columns.includes('Últ. Remun.')) {
                    rowData["Últ. Remun."] = (block.match(/(\d{2}\/\d{4})/g) || [])[0] || '';
                }
                if (columns.includes('Indicadores')) {
                    rowData["Indicadores"] = (block.match(/(IREC-INDPEND|IREM-INDPEND)/) || [])[0] || '';
                }
                if (columns.includes('Matrícula do Trabalhador')) {
                    rowData["Matrícula do Trabalhador"] = (block.match(/Matrícula do Trabalhador\s*([\w-]+)/) || [])[1] || '';
                }

                if (Object.keys(rowData).length > 0) {
                    tableData.push(rowData);
                }
            });
            
            return tableData;
        }
        
        function renderTablePreview(data, columns) {
            const tableHead = document.querySelector('#preview-table thead tr');
            const tableBody = document.querySelector('#preview-table tbody');
            
            // Limpa a tabela
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Cria os cabeçalhos da tabela
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                tableHead.appendChild(th);
            });
            
            // Popula a tabela com os dados extraídos
            data.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = row[col] || '';
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
